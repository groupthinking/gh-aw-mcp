name: Manual Release

on:
  workflow_dispatch:
    inputs:
      bump_type:
        description: 'Version bump type'
        required: true
        type: choice
        options:
          - patch
          - minor
          - major

permissions:
  contents: write

jobs:
  check-permission:
    runs-on: ubuntu-latest
    outputs:
      has-permission: ${{ steps.check-admin.outputs.has-permission }}
    steps:
      - name: Check if user has admin role
        id: check-admin
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            try {
              const { data: userPermission } = await github.rest.repos.getCollaboratorPermissionLevel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                username: context.actor
              });
              
              const permission = userPermission.permission;
              const hasPermission = permission === 'admin';
              
              console.log(`User ${context.actor} has permission: ${permission}`);
              core.setOutput('has-permission', hasPermission);
              
              if (!hasPermission) {
                core.setFailed(`User ${context.actor} does not have admin permission (has: ${permission})`);
              }
            } catch (error) {
              core.setFailed(`Failed to check permissions: ${error.message}`);
            }

  release:
    needs: check-permission
    if: needs.check-permission.outputs.has-permission == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          token: ${{ secrets.GH_AW_GITHUB_TOKEN || secrets.GITHUB_TOKEN }}

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version-file: go.mod
          cache: true

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          # Re-configure remote URL with PAT to ensure tag push triggers release workflow
          git remote set-url origin "https://x-access-token:${{ secrets.GH_AW_GITHUB_TOKEN || secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git"

      - name: Create and push release tag
        run: |
          BUMP_TYPE="${{ inputs.bump_type }}"
          echo "Creating release with bump type: $BUMP_TYPE"
          
          # Get the latest tag
          LATEST_TAG=$(git tag --list 'v[0-9]*.[0-9]*.[0-9]*' | sort -V | tail -1)
          
          if [ -z "$LATEST_TAG" ]; then
            echo "No existing tags found, starting from v0.0.0"
            LATEST_TAG="v0.0.0"
          else
            echo "Latest tag: $LATEST_TAG"
          fi
          
          # Parse version
          VERSION_NUM=$(echo $LATEST_TAG | sed 's/^v//')
          MAJOR=$(echo $VERSION_NUM | cut -d. -f1)
          MINOR=$(echo $VERSION_NUM | cut -d. -f2)
          PATCH=$(echo $VERSION_NUM | cut -d. -f3)
          
          # Bump version based on type
          if [ "$BUMP_TYPE" = "major" ]; then
            MAJOR=$((MAJOR + 1))
            MINOR=0
            PATCH=0
          elif [ "$BUMP_TYPE" = "minor" ]; then
            MINOR=$((MINOR + 1))
            PATCH=0
          elif [ "$BUMP_TYPE" = "patch" ]; then
            PATCH=$((PATCH + 1))
          fi
          
          NEW_VERSION="v$MAJOR.$MINOR.$PATCH"
          echo "New version: $NEW_VERSION"
          
          # Create and push tag
          git tag -a "$NEW_VERSION" -m "Release $NEW_VERSION"
          git push origin "$NEW_VERSION"
          
          echo "✓ Tag $NEW_VERSION created and pushed"
          echo "✓ Release workflow will be triggered automatically"
          echo ""
          echo "Monitor the release workflow at:"
          echo "  https://github.com/${{ github.repository }}/actions/workflows/release.lock.yml"
